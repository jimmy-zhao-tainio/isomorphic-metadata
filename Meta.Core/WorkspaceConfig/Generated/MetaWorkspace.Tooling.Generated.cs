// <auto-generated />
#nullable enable
using System.Xml.Linq;
using Meta.Core.WorkspaceConfig;

namespace Meta.Core.WorkspaceConfig.Generated;

public sealed partial class MetaWorkspace
{
    private const string DefaultContractVersion = "1.0";
    private const string DefaultModelFile = "metadata/model.xml";
    private const string DefaultInstanceDir = "metadata/instance";
    private const string DefaultEncoding = "utf-8-no-bom";
    private const string DefaultNewlines = "lf";
    private const string DefaultWorkspaceName = MetaWorkspaceModels.DefaultWorkspaceName;

    public static MetaWorkspace CreateDefault()
    {
        return new MetaWorkspace
        {
            Workspace = new List<Workspace>
            {
                new()
                {
                    Id = "1",
                    Name = DefaultWorkspaceName,
                    FormatVersion = DefaultContractVersion,
                    WorkspaceLayoutId = "1",
                    EncodingId = "1",
                    NewlinesId = "1",
                    EntitiesOrderId = "1",
                    PropertiesOrderId = "1",
                    RelationshipsOrderId = "1",
                    RowsOrderId = "2",
                    AttributesOrderId = "3",
                },
            },
            WorkspaceLayout = new List<WorkspaceLayout>
            {
                new() { Id = "1", ModelFilePath = DefaultModelFile, InstanceDirPath = DefaultInstanceDir },
            },
            Encoding = new List<Encoding> { new() { Id = "1", Name = DefaultEncoding }, },
            Newlines = new List<Newlines> { new() { Id = "1", Name = DefaultNewlines }, },
            CanonicalOrder = new List<CanonicalOrder>
            {
                new() { Id = "1", Name = "name-ordinal" },
                new() { Id = "2", Name = "id-ordinal" },
                new() { Id = "3", Name = "id-first-then-name-ordinal" },
            },
            EntityStorage = new List<EntityStorage>(),
            PropertyConcept = new List<PropertyConcept>(),
            PropertyConceptLabel = new List<PropertyConceptLabel>(),
        };
    }

    public static MetaWorkspace LoadFromXml(string workspaceXmlPath)
    {
        if (string.IsNullOrWhiteSpace(workspaceXmlPath))
        {
            throw new ArgumentException("Workspace XML path is required.", nameof(workspaceXmlPath));
        }

        var document = XDocument.Load(workspaceXmlPath, LoadOptions.None);
        var root = document.Root ?? throw new InvalidDataException("Workspace XML has no root element.");
        if (!string.Equals(root.Name.LocalName, MetaWorkspaceModels.ModelName, StringComparison.Ordinal))
        {
            throw new InvalidDataException(
                $"Workspace XML root must be '{MetaWorkspaceModels.ModelName}', found '{root.Name.LocalName}'.");
        }

        var raw = new MetaWorkspace
        {
            Workspace = ParseWorkspaceRows(root),
            WorkspaceLayout = ParseWorkspaceLayoutRows(root),
            Encoding = ParseEncodingRows(root),
            Newlines = ParseNewlinesRows(root),
            CanonicalOrder = ParseCanonicalOrderRows(root),
            EntityStorage = ParseEntityStorageRows(root),
            PropertyConcept = ParsePropertyConceptRows(root),
            PropertyConceptLabel = ParsePropertyConceptLabelRows(root),
        };
        return Normalize(raw, workspaceXmlPath);
    }

    public static XDocument BuildDocument(MetaWorkspace workspaceConfig)
    {
        var normalized = Normalize(workspaceConfig, "workspace-config");
        var workspace = RequireSingleWorkspace(normalized, "workspace-config");

        var root = new XElement("MetaWorkspace");
        root.Add(new XElement("Workspaces", normalized.Workspace.Select(ToWorkspaceElement)));
        root.Add(new XElement("WorkspaceLayouts", normalized.WorkspaceLayout.Select(ToWorkspaceLayoutElement)));
        root.Add(new XElement("Encodings", normalized.Encoding.Select(ToEncodingElement)));
        root.Add(new XElement("NewlinesValues", normalized.Newlines.Select(ToNewlinesElement)));
        root.Add(new XElement("CanonicalOrders", normalized.CanonicalOrder.Select(ToCanonicalOrderElement)));

        root.Add(new XElement(
            "EntityStorages",
            normalized.EntityStorage
                .Where(item => string.Equals(item.WorkspaceId, workspace.Id, StringComparison.OrdinalIgnoreCase))
                .OrderBy(item => item.EntityName, StringComparer.OrdinalIgnoreCase)
                .ThenBy(item => ParseId(item.Id))
                .Select(ToEntityStorageElement)));

        root.Add(new XElement(
            "PropertyConcepts",
            normalized.PropertyConcept
                .Where(item => string.Equals(item.WorkspaceId, workspace.Id, StringComparison.OrdinalIgnoreCase))
                .OrderBy(item => item.Name, StringComparer.OrdinalIgnoreCase)
                .ThenBy(item => ParseId(item.Id))
                .Select(ToPropertyConceptElement)));

        root.Add(new XElement(
            "PropertyConceptLabels",
            normalized.PropertyConceptLabel
                .OrderBy(item => item.Label, StringComparer.OrdinalIgnoreCase)
                .ThenBy(item => ParseId(item.Id))
                .Select(ToPropertyConceptLabelElement)));

        return new XDocument(new XDeclaration("1.0", "utf-8", null), root);
    }

    public static MetaWorkspace Normalize(MetaWorkspace? workspaceConfig, string sourcePath)
    {
        if (workspaceConfig == null || workspaceConfig.Workspace.Count == 0)
        {
            return CreateDefault();
        }

        var workspace = RequireSingleWorkspace(workspaceConfig, sourcePath);
        var normalized = CreateDefault();
        var targetWorkspace = normalized.Workspace[0];

        targetWorkspace.Name = string.IsNullOrWhiteSpace(workspace.Name) ? DefaultWorkspaceName : workspace.Name.Trim();
        targetWorkspace.FormatVersion = NormalizeContractVersion(workspace.FormatVersion);

        var layout = RequireById(workspaceConfig.WorkspaceLayout, workspace.WorkspaceLayoutId, "WorkspaceLayout", sourcePath);
        var encoding = RequireById(workspaceConfig.Encoding, workspace.EncodingId, "Encoding", sourcePath);
        var newlines = RequireById(workspaceConfig.Newlines, workspace.NewlinesId, "Newlines", sourcePath);
        var entitiesOrder = RequireById(workspaceConfig.CanonicalOrder, workspace.EntitiesOrderId, "CanonicalOrder", sourcePath);
        var propertiesOrder = RequireById(workspaceConfig.CanonicalOrder, workspace.PropertiesOrderId, "CanonicalOrder", sourcePath);
        var relationshipsOrder = RequireById(workspaceConfig.CanonicalOrder, workspace.RelationshipsOrderId, "CanonicalOrder", sourcePath);
        var rowsOrder = RequireById(workspaceConfig.CanonicalOrder, workspace.RowsOrderId, "CanonicalOrder", sourcePath);
        var attributesOrder = RequireById(workspaceConfig.CanonicalOrder, workspace.AttributesOrderId, "CanonicalOrder", sourcePath);

        normalized.WorkspaceLayout[0].ModelFilePath = NormalizeRelativePath(layout.ModelFilePath, DefaultModelFile);
        normalized.WorkspaceLayout[0].InstanceDirPath = NormalizeRelativePath(layout.InstanceDirPath, DefaultInstanceDir);
        normalized.Encoding[0].Name = NormalizeToken(encoding.Name, DefaultEncoding);
        normalized.Newlines[0].Name = NormalizeToken(newlines.Name, DefaultNewlines);

        normalized.CanonicalOrder = BuildCanonicalOrders(
            NormalizeToken(entitiesOrder.Name, "name-ordinal"),
            NormalizeToken(propertiesOrder.Name, "name-ordinal"),
            NormalizeToken(relationshipsOrder.Name, "name-ordinal"),
            NormalizeToken(rowsOrder.Name, "id-ordinal"),
            NormalizeToken(attributesOrder.Name, "id-first-then-name-ordinal"));
        targetWorkspace.EntitiesOrderId = ResolveCanonicalOrderId(normalized.CanonicalOrder, NormalizeToken(entitiesOrder.Name, "name-ordinal"));
        targetWorkspace.PropertiesOrderId = ResolveCanonicalOrderId(normalized.CanonicalOrder, NormalizeToken(propertiesOrder.Name, "name-ordinal"));
        targetWorkspace.RelationshipsOrderId = ResolveCanonicalOrderId(normalized.CanonicalOrder, NormalizeToken(relationshipsOrder.Name, "name-ordinal"));
        targetWorkspace.RowsOrderId = ResolveCanonicalOrderId(normalized.CanonicalOrder, NormalizeToken(rowsOrder.Name, "id-ordinal"));
        targetWorkspace.AttributesOrderId = ResolveCanonicalOrderId(normalized.CanonicalOrder, NormalizeToken(attributesOrder.Name, "id-first-then-name-ordinal"));

        normalized.EntityStorage = (workspaceConfig.EntityStorage ?? new List<EntityStorage>())
            .Where(item => string.Equals(item.WorkspaceId, workspace.Id, StringComparison.OrdinalIgnoreCase))
            .Where(item => !string.IsNullOrWhiteSpace(item.EntityName))
            .OrderBy(item => item.EntityName, StringComparer.OrdinalIgnoreCase)
            .ThenBy(item => ParseId(item.Id))
            .Select((item, index) => new EntityStorage
            {
                Id = (index + 1).ToString(),
                WorkspaceId = targetWorkspace.Id,
                Workspace = targetWorkspace,
                EntityName = item.EntityName.Trim(),
                StorageKind = string.IsNullOrWhiteSpace(item.StorageKind) ? "Sharded" : item.StorageKind.Trim(),
                DirectoryPath = item.DirectoryPath ?? string.Empty,
                FilePath = item.FilePath ?? string.Empty,
                Pattern = item.Pattern ?? string.Empty,
            })
            .ToList();

        var concepts = (workspaceConfig.PropertyConcept ?? new List<PropertyConcept>())
            .Where(item => string.Equals(item.WorkspaceId, workspace.Id, StringComparison.OrdinalIgnoreCase))
            .Where(item => !string.IsNullOrWhiteSpace(item.Name))
            .OrderBy(item => item.Name, StringComparer.OrdinalIgnoreCase)
            .ThenBy(item => ParseId(item.Id))
            .ToList();
        normalized.PropertyConcept = new List<PropertyConcept>();
        normalized.PropertyConceptLabel = new List<PropertyConceptLabel>();
        var nextConceptId = 1;
        var nextLabelId = 1;
        foreach (var concept in concepts)
        {
            var conceptRow = new PropertyConcept
            {
                Id = nextConceptId.ToString(),
                WorkspaceId = targetWorkspace.Id,
                Workspace = targetWorkspace,
                Name = concept.Name.Trim(),
                Description = concept.Description ?? string.Empty,
            };
            nextConceptId++;
            normalized.PropertyConcept.Add(conceptRow);

            foreach (var label in (workspaceConfig.PropertyConceptLabel ?? new List<PropertyConceptLabel>())
                         .Where(item => string.Equals(item.PropertyConceptId, concept.Id, StringComparison.OrdinalIgnoreCase))
                         .Where(item => !string.IsNullOrWhiteSpace(item.Label))
                         .Select(item => item.Label.Trim())
                         .Distinct(StringComparer.OrdinalIgnoreCase)
                         .OrderBy(item => item, StringComparer.OrdinalIgnoreCase))
            {
                normalized.PropertyConceptLabel.Add(new PropertyConceptLabel
                {
                    Id = nextLabelId.ToString(),
                    PropertyConceptId = conceptRow.Id,
                    PropertyConcept = conceptRow,
                    Label = label,
                });
                nextLabelId++;
            }
        }

        return normalized;
    }

    public static string GetContractVersion(MetaWorkspace workspaceConfig)
    {
        return RequireSingleWorkspace(Normalize(workspaceConfig, "workspace-config"), "workspace-config").FormatVersion;
    }

    public static string GetModelFile(MetaWorkspace workspaceConfig)
    {
        return Normalize(workspaceConfig, "workspace-config").WorkspaceLayout[0].ModelFilePath;
    }

    public static string GetInstanceDir(MetaWorkspace workspaceConfig)
    {
        return Normalize(workspaceConfig, "workspace-config").WorkspaceLayout[0].InstanceDirPath;
    }

    public static void SetInstanceDir(MetaWorkspace workspaceConfig, string instanceDir)
    {
        ArgumentNullException.ThrowIfNull(workspaceConfig);
        var normalized = Normalize(workspaceConfig, "workspace-config");
        normalized.WorkspaceLayout[0].InstanceDirPath = NormalizeRelativePath(instanceDir, DefaultInstanceDir);
        ReplaceSnapshot(workspaceConfig, normalized);
    }

    public static bool TryParseContractVersion(string? value, out int major, out int minor)
    {
        major = 0;
        minor = 0;
        if (string.IsNullOrWhiteSpace(value))
        {
            return false;
        }

        var parts = value.Trim().Split('.', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length == 0 || parts.Length > 2)
        {
            return false;
        }

        if (!int.TryParse(parts[0], out major))
        {
            return false;
        }

        if (parts.Length == 2 && !int.TryParse(parts[1], out minor))
        {
            return false;
        }

        return major >= 0 && minor >= 0;
    }

    private static void ReplaceSnapshot(MetaWorkspace target, MetaWorkspace source)
    {
        target.Workspace = source.Workspace;
        target.WorkspaceLayout = source.WorkspaceLayout;
        target.Encoding = source.Encoding;
        target.Newlines = source.Newlines;
        target.CanonicalOrder = source.CanonicalOrder;
        target.EntityStorage = source.EntityStorage;
        target.PropertyConcept = source.PropertyConcept;
        target.PropertyConceptLabel = source.PropertyConceptLabel;
    }

    private static Workspace RequireSingleWorkspace(MetaWorkspace workspaceConfig, string sourcePath)
    {
        if (workspaceConfig.Workspace.Count == 1)
        {
            return workspaceConfig.Workspace[0];
        }

        if (workspaceConfig.Workspace.Count == 0)
        {
            throw new InvalidDataException($"Workspace config '{sourcePath}' must contain exactly one Workspace row.");
        }

        throw new InvalidDataException($"Workspace config '{sourcePath}' contains duplicate Workspace rows.");
    }

    private static T RequireById<T>(IReadOnlyCollection<T> rows, string? id, string entityName, string sourcePath)
        where T : class
    {
        if (string.IsNullOrWhiteSpace(id))
        {
            throw new InvalidDataException($"Workspace config '{sourcePath}' is missing required relationship id for '{entityName}'.");
        }

        var matches = rows.Where(item => string.Equals(GetId(item), id, StringComparison.OrdinalIgnoreCase)).ToList();
        if (matches.Count == 1)
        {
            return matches[0];
        }

        if (matches.Count == 0)
        {
            throw new InvalidDataException($"Workspace config '{sourcePath}' is missing {entityName} row with Id '{id}'.");
        }

        throw new InvalidDataException($"Workspace config '{sourcePath}' has duplicate {entityName} rows with Id '{id}'.");
    }

    private static string GetId<T>(T row)
    {
        return row switch
        {
            Workspace value => value.Id,
            WorkspaceLayout value => value.Id,
            Encoding value => value.Id,
            Newlines value => value.Id,
            CanonicalOrder value => value.Id,
            EntityStorage value => value.Id,
            PropertyConcept value => value.Id,
            PropertyConceptLabel value => value.Id,
            _ => string.Empty,
        };
    }

    private static List<CanonicalOrder> BuildCanonicalOrders(
        string entities,
        string properties,
        string relationships,
        string rows,
        string attributes)
    {
        var orderedNames = new List<string>();
        AddIfMissing(entities);
        AddIfMissing(properties);
        AddIfMissing(relationships);
        AddIfMissing(rows);
        AddIfMissing(attributes);
        return orderedNames
            .Select((name, index) => new CanonicalOrder { Id = (index + 1).ToString(), Name = name })
            .ToList();

        void AddIfMissing(string value)
        {
            if (!orderedNames.Contains(value, StringComparer.OrdinalIgnoreCase))
            {
                orderedNames.Add(value);
            }
        }
    }

    private static string ResolveCanonicalOrderId(IReadOnlyCollection<CanonicalOrder> orders, string name)
    {
        return orders.First(item => string.Equals(item.Name, name, StringComparison.OrdinalIgnoreCase)).Id;
    }

    private static XElement ToWorkspaceElement(Workspace row)
    {
        return new XElement(
            "Workspace",
            new XAttribute("Id", row.Id),
            new XAttribute("WorkspaceLayoutId", row.WorkspaceLayoutId),
            new XAttribute("EncodingId", row.EncodingId),
            new XAttribute("NewlinesId", row.NewlinesId),
            new XAttribute("EntitiesOrderId", row.EntitiesOrderId),
            new XAttribute("PropertiesOrderId", row.PropertiesOrderId),
            new XAttribute("RelationshipsOrderId", row.RelationshipsOrderId),
            new XAttribute("RowsOrderId", row.RowsOrderId),
            new XAttribute("AttributesOrderId", row.AttributesOrderId),
            new XElement("Name", row.Name),
            new XElement("FormatVersion", row.FormatVersion));
    }

    private static XElement ToWorkspaceLayoutElement(WorkspaceLayout row)
    {
        return new XElement(
            "WorkspaceLayout",
            new XAttribute("Id", row.Id),
            new XElement("ModelFilePath", row.ModelFilePath),
            new XElement("InstanceDirPath", row.InstanceDirPath));
    }

    private static XElement ToEncodingElement(Encoding row)
    {
        return new XElement(
            "Encoding",
            new XAttribute("Id", row.Id),
            new XElement("Name", row.Name));
    }

    private static XElement ToNewlinesElement(Newlines row)
    {
        return new XElement(
            "Newlines",
            new XAttribute("Id", row.Id),
            new XElement("Name", row.Name));
    }

    private static XElement ToCanonicalOrderElement(CanonicalOrder row)
    {
        return new XElement(
            "CanonicalOrder",
            new XAttribute("Id", row.Id),
            new XElement("Name", row.Name));
    }

    private static XElement ToEntityStorageElement(EntityStorage row)
    {
        var element = new XElement(
            "EntityStorage",
            new XAttribute("Id", row.Id),
            new XAttribute("WorkspaceId", row.WorkspaceId),
            new XElement("EntityName", row.EntityName),
            new XElement("StorageKind", row.StorageKind));
        AddOptionalElement(element, "DirectoryPath", row.DirectoryPath);
        AddOptionalElement(element, "FilePath", row.FilePath);
        AddOptionalElement(element, "Pattern", row.Pattern);
        return element;
    }

    private static XElement ToPropertyConceptElement(PropertyConcept row)
    {
        var element = new XElement(
            "PropertyConcept",
            new XAttribute("Id", row.Id),
            new XAttribute("WorkspaceId", row.WorkspaceId),
            new XElement("Name", row.Name));
        AddOptionalElement(element, "Description", row.Description);
        return element;
    }

    private static XElement ToPropertyConceptLabelElement(PropertyConceptLabel row)
    {
        return new XElement(
            "PropertyConceptLabel",
            new XAttribute("Id", row.Id),
            new XAttribute("PropertyConceptId", row.PropertyConceptId),
            new XElement("Label", row.Label));
    }

    private static void AddOptionalElement(XContainer container, string name, string? value)
    {
        if (!string.IsNullOrWhiteSpace(value))
        {
            container.Add(new XElement(name, value));
        }
    }

    private static List<Workspace> ParseWorkspaceRows(XElement root)
    {
        return GetRows(root, "Workspaces", "Workspace")
            .Select(item => new Workspace
            {
                Id = (string?)item.Attribute("Id") ?? string.Empty,
                WorkspaceLayoutId = (string?)item.Attribute("WorkspaceLayoutId") ?? string.Empty,
                EncodingId = (string?)item.Attribute("EncodingId") ?? string.Empty,
                NewlinesId = (string?)item.Attribute("NewlinesId") ?? string.Empty,
                EntitiesOrderId = (string?)item.Attribute("EntitiesOrderId") ?? string.Empty,
                PropertiesOrderId = (string?)item.Attribute("PropertiesOrderId") ?? string.Empty,
                RelationshipsOrderId = (string?)item.Attribute("RelationshipsOrderId") ?? string.Empty,
                RowsOrderId = (string?)item.Attribute("RowsOrderId") ?? string.Empty,
                AttributesOrderId = (string?)item.Attribute("AttributesOrderId") ?? string.Empty,
                Name = (string?)item.Element("Name") ?? string.Empty,
                FormatVersion = (string?)item.Element("FormatVersion") ?? string.Empty,
            })
            .ToList();
    }

    private static List<WorkspaceLayout> ParseWorkspaceLayoutRows(XElement root)
    {
        return GetRows(root, "WorkspaceLayouts", "WorkspaceLayout")
            .Select(item => new WorkspaceLayout
            {
                Id = (string?)item.Attribute("Id") ?? string.Empty,
                ModelFilePath = (string?)item.Element("ModelFilePath") ?? string.Empty,
                InstanceDirPath = (string?)item.Element("InstanceDirPath") ?? string.Empty,
            })
            .ToList();
    }

    private static List<Encoding> ParseEncodingRows(XElement root)
    {
        return GetRows(root, "Encodings", "Encoding")
            .Select(item => new Encoding
            {
                Id = (string?)item.Attribute("Id") ?? string.Empty,
                Name = (string?)item.Element("Name") ?? string.Empty,
            })
            .ToList();
    }

    private static List<Newlines> ParseNewlinesRows(XElement root)
    {
        return GetRows(root, "NewlinesValues", "Newlines")
            .Select(item => new Newlines
            {
                Id = (string?)item.Attribute("Id") ?? string.Empty,
                Name = (string?)item.Element("Name") ?? string.Empty,
            })
            .ToList();
    }

    private static List<CanonicalOrder> ParseCanonicalOrderRows(XElement root)
    {
        return GetRows(root, "CanonicalOrders", "CanonicalOrder")
            .Select(item => new CanonicalOrder
            {
                Id = (string?)item.Attribute("Id") ?? string.Empty,
                Name = (string?)item.Element("Name") ?? string.Empty,
            })
            .ToList();
    }

    private static List<EntityStorage> ParseEntityStorageRows(XElement root)
    {
        return GetRows(root, "EntityStorages", "EntityStorage")
            .Select(item => new EntityStorage
            {
                Id = (string?)item.Attribute("Id") ?? string.Empty,
                WorkspaceId = (string?)item.Attribute("WorkspaceId") ?? string.Empty,
                EntityName = (string?)item.Element("EntityName") ?? string.Empty,
                StorageKind = (string?)item.Element("StorageKind") ?? string.Empty,
                DirectoryPath = (string?)item.Element("DirectoryPath") ?? string.Empty,
                FilePath = (string?)item.Element("FilePath") ?? string.Empty,
                Pattern = (string?)item.Element("Pattern") ?? string.Empty,
            })
            .ToList();
    }

    private static List<PropertyConcept> ParsePropertyConceptRows(XElement root)
    {
        return GetRows(root, "PropertyConcepts", "PropertyConcept")
            .Select(item => new PropertyConcept
            {
                Id = (string?)item.Attribute("Id") ?? string.Empty,
                WorkspaceId = (string?)item.Attribute("WorkspaceId") ?? string.Empty,
                Name = (string?)item.Element("Name") ?? string.Empty,
                Description = (string?)item.Element("Description") ?? string.Empty,
            })
            .ToList();
    }

    private static List<PropertyConceptLabel> ParsePropertyConceptLabelRows(XElement root)
    {
        return GetRows(root, "PropertyConceptLabels", "PropertyConceptLabel")
            .Select(item => new PropertyConceptLabel
            {
                Id = (string?)item.Attribute("Id") ?? string.Empty,
                PropertyConceptId = (string?)item.Attribute("PropertyConceptId") ?? string.Empty,
                Label = (string?)item.Element("Label") ?? string.Empty,
            })
            .ToList();
    }

    private static IEnumerable<XElement> GetRows(XElement root, string containerName, string rowName)
    {
        return root.Element(containerName)?.Elements(rowName) ?? Array.Empty<XElement>();
    }

    private static string NormalizeContractVersion(string? value)
    {
        return string.IsNullOrWhiteSpace(value) ? DefaultContractVersion : value.Trim();
    }

    private static string NormalizeToken(string? value, string fallback)
    {
        return string.IsNullOrWhiteSpace(value) ? fallback : value.Trim().ToLowerInvariant();
    }

    private static string NormalizeRelativePath(string? value, string fallback)
    {
        if (string.IsNullOrWhiteSpace(value))
        {
            return fallback;
        }

        var normalized = value.Trim().Replace('\\', '/');
        normalized = normalized.TrimStart('/');
        while (normalized.Contains("//", StringComparison.Ordinal))
        {
            normalized = normalized.Replace("//", "/", StringComparison.Ordinal);
        }

        return string.IsNullOrWhiteSpace(normalized) ? fallback : normalized;
    }

    private static int ParseId(string? value)
    {
        return int.TryParse(value, out var parsed) ? parsed : int.MaxValue;
    }
}
